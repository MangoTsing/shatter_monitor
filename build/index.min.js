var shatter=function(t){"use strict";var e,r;!function(t){t.JAVASCRIPT_ERROR="JAVASCRIPT_ERROR",t.BUSINESS_ERROR="BUSINESS_ERROR",t.LOG_ERROR="LOG_ERROR",t.FETCH_ERROR="HTTP_ERROR",t.RESOURCE_ERROR="RESOURCE_ERROR",t.PROMISE_ERROR="PROMISE_ERROR"}(e||(e={})),function(t){t.jsError="JS_ERROR",t.sourceError="SOURCE_ERROR",t.promiseError="UNHANDLEDREJECTION",t.consoleError="CONSOLE_ERROR",t.ajaxError="AJAX_ERROR",t.fetchError="FETCH_ERROR"}(r||(r={}));const o=function(t,o){if(!o.blockTry){const t=EventTarget.prototype.addEventListener;EventTarget.prototype.addEventListener=function(e,r,o){return t.call(this,e,(function(){try{return r.apply(this,arguments)}catch(t){throw t}}),o)}}if(!o.blockError){const o=window.onerror||null;window.onerror=(n,s,i,c,a)=>{t.report({name:r.jsError,msg:n,url:s,line:i,col:c,type:e.JAVASCRIPT_ERROR}),o&&o(n,s,i,c,a)}}if(o.blockSource||window.addEventListener("error",o=>{if(!o)return;const n=o.target||o.srcElement;if(!(n instanceof HTMLScriptElement||n instanceof HTMLLinkElement||n instanceof HTMLImageElement))return!1;const s=n.src||n.href;t.report({name:r.sourceError,url:s,type:e.RESOURCE_ERROR})},!0),o.blockPromise||window.addEventListener("unhandledrejection",o=>{if(!o.reason||!o.reason.stack)return void t.report({name:r.promiseError,type:e.PROMISE_ERROR});const n=o.reason.stack.split("\n")[1].split("at ")[1],s=n.split(":"),i=s[s.length-2],c=s[s.length-1],a=n.slice(0,-i.length-c.length-2),R=o.reason.message;t.report({name:r.promiseError,msg:R,url:a,line:i,col:c,type:e.PROMISE_ERROR})},!0),!o.blockConsole){const o=window.console.error;window.console.error=(n=o,(...o)=>{o.forEach(o=>{if(n=o,Object.prototype.toString.call(n).indexOf("Error")>-1){const n=o.stack.split("\n")[1].split("at ")[1],s=n.split(":"),i=s[s.length-2],c=s[s.length-2],a=n.split("(")[1].slice(0,-i.length-c.length-2);t.report({name:r.consoleError,msg:o.stack,url:a,line:i,col:c,type:e.LOG_ERROR})}else t.report({name:r.consoleError,msg:o,type:e.LOG_ERROR});var n}),n.apply(console,o)})}var n};class n{constructor(t){this.options=t}beforeSendData(t){if(!this.options.beforeSendData)return!0;try{return this.options.beforeSendData(t)}catch(t){throw t}}}var s;!function(t){t.img="img",t.beacon="beacon"}(s||(s={}));return t.Shatter=class{constructor(t){this.sendType="img",this.options=t,this._init()}_init(){const t=this.options,{blockConsole:s,blockPromise:i,blockError:c,blockSource:a,blockXhr:R,blockFetch:l,blockTry:E,blockHttpRequest:p,onlyHttpRequest:h}=t;this.hooks=new n(t),window.navigator&&window.navigator.sendBeacon&&!t.onlyImg&&(this.sendType="beacon"),h||o(this,{blockConsole:s,blockPromise:i,blockError:c,blockSource:a,blockTry:E}),p||(R||function(t){if(!window.XMLHttpRequest)return;const e=window.XMLHttpRequest,r=e.prototype.send,o=function(e){e&&e.currentTarget&&200!==e.currentTarget.status&&t&&t(e)};e.prototype.send=function(){if(this.addEventListener)this.addEventListener("error",o),this.addEventListener("load",o),this.addEventListener("abort",o);else{const t=this.onreadystatechange;this.onreadystatechange=function(e){4===this.readyState&&o(e),t&&t.apply(this,arguments)}}return r.apply(this,arguments)}}(t=>{const o=t.currentTarget;this.report({name:r.ajaxError,url:o.responseURL,type:e.FETCH_ERROR,response:{status:o.status,data:o.statusText}})}),l||function(t,e){if(!window.fetch)return;const r=window.fetch;window.fetch=function(){const o=arguments;return r.apply(this,arguments).then(e=>(e.ok||t&&t(e),e)).catch(t=>{throw e&&e(t.toString(),o),t})}}(t=>{this.report({name:r.fetchError,url:t.url,msg:t.statusText,type:e.FETCH_ERROR,response:{status:t.status,data:t.statusText}})},(t,o)=>{const n="https"===o[0].substr(0,5)?"https":"other";this.report({name:r.fetchError,msg:t,type:e.FETCH_ERROR,request:{httpType:n,data:o[1].body,method:o[1].method,url:o[0]}})}))}report(t){const{dsn:e,appkey:r}=this.options;Object.assign(t,{_t:(new Date).getTime(),appkey:r});if(!this.hooks.beforeSendData(t))return!1;const o=(n=t,Object.entries(n).reduce((t,[e,r],o)=>("object"==typeof r&&(r=JSON.stringify(r)),0!==o&&(t+="&"),t+=`${e}=${r}`),""));var n,s;this.options.debug?console.log(`log to : ${e}?${o}`):"img"===this.sendType?(s=`${e}?${o}`,(new Image).src=s):"beacon"===this.sendType&&function(t,e="formData"){if("formData"!==e)return;const r=new FormData;for(const e in t){if("dsn"===e)continue;let o=t[e];"object"==typeof o&&(o=JSON.stringify(o)),r.append(e,o)}window.navigator.sendBeacon(t.dsn,r)}(Object.assign(t,{dsn:e}))}},Object.defineProperty(t,"__esModule",{value:!0}),t}({});
